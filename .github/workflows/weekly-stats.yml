name: Weekly Actions Statistics Collection
on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ åˆå‰2æ™‚30åˆ† (UTC) ã«å®Ÿè¡Œ
    - cron: '30 2 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  collect-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          appId: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      
      - name: Set date range
        run: |
          echo "START_DATE=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_ENV
          echo "END_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "REPORT_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
      
      - name: Collect workflow statistics
        run: |
          # å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å–å¾—
          gh api repos/${{ github.repository }}/actions/workflows \
            --jq '.workflows[] | {id: .id, name: .name, path: .path}' > workflows.json
          
          # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
          echo "[]" > weekly_stats.json
          
          # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          while IFS= read -r workflow; do
            id=$(echo $workflow | jq -r '.id')
            name=$(echo $workflow | jq -r '.name')
            
            echo "Collecting data for workflow: $name"
            
            # éå»7æ—¥é–“ã®å®Ÿè¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            gh api "repos/${{ github.repository }}/actions/workflows/$id/runs" \
              --paginate \
              --jq ".workflow_runs[] | select(.created_at >= \"$START_DATE\" and .created_at <= \"$END_DATE\")" \
              > "runs_$id.json"
            
            # çµ±è¨ˆè¨ˆç®—
            if [ -s "runs_$id.json" ]; then
              cat "runs_$id.json" | jq -s "
                {
                  workflow_name: \"$name\",
                  workflow_id: $id,
                  period: {
                    start: \"$START_DATE\",
                    end: \"$END_DATE\"
                  },
                  total_runs: length,
                  success_count: (map(select(.conclusion == \"success\")) | length),
                  failure_count: (map(select(.conclusion == \"failure\")) | length),
                  cancelled_count: (map(select(.conclusion == \"cancelled\")) | length),
                  success_rate: (if length > 0 then (map(select(.conclusion == \"success\")) | length) / length * 100 else 0 end),
                  failure_rate: (if length > 0 then (map(select(.conclusion == \"failure\")) | length) / length * 100 else 0 end),
                  avg_duration_seconds: (
                    map(select(.conclusion == \"success\") | 
                      if .run_started_at and .updated_at then 
                        ((.updated_at | strptime(\"%Y-%m-%dT%H:%M:%SZ\") | mktime) - 
                         (.run_started_at | strptime(\"%Y-%m-%dT%H:%M:%SZ\") | mktime))
                      else 0 end
                    ) | if length > 0 then add / length else 0 end
                  ),
                  last_run_at: (map(.created_at) | max)
                }
              " >> temp_stat.json
              
              # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
              jq -s '. + [input]' weekly_stats.json temp_stat.json > updated_stats.json
              mv updated_stats.json weekly_stats.json
              rm temp_stat.json
            fi
          done < workflows.json
          
          # æœ€çµ‚çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ•´ç†
          cat weekly_stats.json | jq '{
            generated_at: now | strftime("%Y-%m-%dT%H:%M:%SZ"),
            repository: "${{ github.repository }}",
            statistics: .
          }' > final_stats.json
          
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
      
      - name: Update actions-log.json
        run: |
          # actions-log.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ã¾ãŸã¯ä½œæˆ
          if [ -f "actions-log.json" ]; then
            # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            jq --argjson new_data "$(cat final_stats.json)" '. + [$new_data]' actions-log.json > updated_log.json
            mv updated_log.json actions-log.json
          else
            # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
            jq -s '.' final_stats.json > actions-log.json
          fi
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆæœ€æ–°50ã‚¨ãƒ³ãƒˆãƒªã¾ã§ä¿æŒï¼‰
          jq '.[(-50):]' actions-log.json > temp_log.json
          mv temp_log.json actions-log.json
          
          # èª­ã¿ã‚„ã™ã„å½¢å¼ã§æ•´ç†
          jq --indent 2 '.' actions-log.json > formatted_log.json
          mv formatted_log.json actions-log.json
      
      - name: Create detailed report
        run: |
          cat << 'EOF' > weekly_report.md
          # é€±æ¬¡ GitHub Actions çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
          
          **ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæ—¥**: $(date '+%Yå¹´%mæœˆ%dæ—¥')  
          **å¯¾è±¡æœŸé–“**: $START_DATE ã‹ã‚‰ $END_DATE ã¾ã§
          
          ## çµ±è¨ˆã‚µãƒãƒªãƒ¼
          
          | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å | å®Ÿè¡Œå›æ•° | æˆåŠŸç‡ | å¤±æ•—ç‡ | å¹³å‡å®Ÿè¡Œæ™‚é–“(ç§’) | æœ€çµ‚å®Ÿè¡Œæ—¥ |
          |---|---|---|---|---|---|
          EOF
          
          # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
          cat final_stats.json | jq -r '
            .statistics[] | 
            "| \(.workflow_name) | \(.total_runs) | \(.success_rate | tostring | .[0:5])% | \(.failure_rate | tostring | .[0:5])% | \(.avg_duration_seconds | tostring | .[0:6]) | \(.last_run_at // "N/A") |"
          ' >> weekly_report.md
          
          cat << 'EOF' >> weekly_report.md
          
          ## è©³ç´°åˆ†æ
          
          ### æˆåŠŸç‡ãŒ90%æœªæº€ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
          EOF
          
          # å•é¡Œã®ã‚ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç‰¹å®š
          cat final_stats.json | jq -r '
            .statistics[] | 
            select(.success_rate < 90 and .total_runs > 0) | 
            "- **\(.workflow_name)**: æˆåŠŸç‡ \(.success_rate | tostring | .[0:5])% (\(.success_count)/\(.total_runs) å›æˆåŠŸ)"
          ' >> weekly_report.md
          
          echo "" >> weekly_report.md
          echo "### å®Ÿè¡Œæ™‚é–“ãŒé•·ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (60ç§’ä»¥ä¸Š)" >> weekly_report.md
          
          cat final_stats.json | jq -r '
            .statistics[] | 
            select(.avg_duration_seconds > 60) | 
            "- **\(.workflow_name)**: å¹³å‡å®Ÿè¡Œæ™‚é–“ \(.avg_duration_seconds | tostring | .[0:6]) ç§’"
          ' >> weekly_report.md
          
          # å¤‰æ•°ã®å±•é–‹
          envsubst < weekly_report.md > final_report.md
          mv final_report.md weekly_report.md
      
      - name: Create pull request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "chore: update weekly actions statistics (${{ env.REPORT_DATE }})"
          title: "ğŸ“Š é€±æ¬¡ Actions çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ - ${{ env.REPORT_DATE }}"
          body-path: weekly_report.md
          branch: actions-stats-${{ env.REPORT_DATE }}
          delete-branch: true
          labels: |
            automation
            statistics
            actions
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner }}
      
      - name: Auto-merge pull request
        if: steps.create-pr.outputs.pull-request-number
        run: |
          # çŸ­ã„å¾…æ©Ÿå¾Œã«ãƒãƒ¼ã‚¸å®Ÿè¡Œ
          sleep 10
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch
          
          echo "Auto-merge enabled for PR #${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
      
      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f workflows.json runs_*.json final_stats.json weekly_stats.json temp_stat.json
          echo "Cleanup completed"
